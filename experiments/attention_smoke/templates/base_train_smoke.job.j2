#!/bin/bash
#SBATCH --job-name={{ job_name }}
#SBATCH --partition={{ slurm.partition }}
#SBATCH --time={{ slurm.time }}
#SBATCH --mem={{ slurm.mem }}
#SBATCH --nodes={{ slurm.nodes }}
#SBATCH --ntasks={{ slurm.ntasks }}
#SBATCH --cpus-per-task={{ slurm.cpus_per_task }}
#SBATCH --gres=gpu:{{ slurm.gpus }}
#SBATCH --output={{ logs_dir }}/{{ job_name }}.%j.out
#SBATCH --error={{ logs_dir }}/{{ job_name }}.%j.err

set -euo pipefail

echo "==== attention smoke job start ===="
echo "job_name={{ job_name }}"
echo "attention_impl={{ attention_impl }}"
echo "host=$(hostname)"
echo "job_id=${SLURM_JOB_ID:-local}"

CLUSTER="{{ slurm.cluster }}"
{% if slurm.cluster == "none" %}
PROJECT_ROOT="/Users/awni/Documents/project-code/abstractor-nanochat"
{% elif slurm.cluster == "bouchet" %}
PROJECT_ROOT="/home/ma2393/project_pi_jl2994/ma2393/abstractor-nanochat"
{% elif slurm.cluster == "misha" %}
PROJECT_ROOT="/gpfs/radev/home/ma2393/project/analogical-exploration"
{% else %}
echo "ERROR: Unsupported cluster '{{ slurm.cluster }}'. Expected one of: none, bouchet, misha." >&2
exit 1
{% endif %}

echo "cluster=${CLUSTER}"
echo "project_root=${PROJECT_ROOT}"

cd "${PROJECT_ROOT}"

if [ -f ".venv/bin/activate" ]; then
  source .venv/bin/activate
fi

export NANOCHAT_BASE_DIR="${PROJECT_ROOT}/.cache"
mkdir -p "${NANOCHAT_BASE_DIR}"

python -m scripts.base_train \
  --run dummy \
  --device-type cuda \
  --depth {{ depth }} \
  --aspect-ratio {{ aspect_ratio }} \
  --head-dim {{ head_dim }} \
  --max-seq-len {{ max_seq_len }} \
  --window-pattern {{ window_pattern }} \
  --attention-impl {{ attention_impl }} \
  --dual-rel-head-proportion {{ dual_rel_head_proportion }} \
  --residual-gate-channels {{ residual_gate_channels }} \
  --device-batch-size {{ device_batch_size }} \
  --total-batch-size {{ total_batch_size }} \
  --num-iterations {{ num_iterations }} \
  --eval-every -1 \
  --core-metric-every -1 \
  --sample-every -1 \
  --save-every -1 \
  --model-tag attnsmoke_{{ attention_impl }}

echo "==== attention smoke job success ===="
